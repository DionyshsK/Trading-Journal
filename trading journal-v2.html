<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Trading Journal v13 - Mobile Ready</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151', 100: '#f3f4f6' },
                        brand: { 500: '#6366f1', 600: '#4f46e5' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth Scrolling & Scrollbars */
        .scroll-shadow { box-shadow: inset 0 -4px 4px -4px rgba(0, 0, 0, 0.1); }
        .dark ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        /* Animations */
        .dropdown-menu { transition: all 0.2s ease-in-out; transform-origin: top left; }
        .hidden-menu { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .visible-menu { opacity: 1; transform: scale(1); pointer-events: auto; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #4f46e5; cursor: pointer; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #d1d5db; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #4b5563; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200 selection:bg-indigo-500 selection:text-white">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-8 relative">
            
            <div id="forgot-pass-modal" class="absolute inset-0 bg-white dark:bg-gray-800 rounded-2xl z-20 hidden flex-col items-center justify-center p-8">
                <h3 class="text-xl font-bold mb-4">Reset Password</h3>
                <p class="text-sm text-gray-500 mb-4 text-center">Enter your email to receive a reset link.</p>
                <input type="email" id="reset-email" placeholder="email@example.com" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 p-3 mb-4 bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500">
                <div class="flex space-x-3 w-full">
                    <button id="cancel-reset" class="flex-1 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white font-medium">Cancel</button>
                    <button id="send-reset" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Send Link</button>
                </div>
            </div>

            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">Trading Journal</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Track. Analyze. Improve.</p>
            </div>

            <form id="auth-form" class="space-y-5">
                <div id="register-fields" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">First Name</label><input type="text" id="auth-fname" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Last Name</label><input type="text" id="auth-lname" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500"></div>
                    </div>
                    <div><label class="block text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1">Username</label><input type="text" id="auth-username" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500"></div>
                </div>

                <div><label class="block text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1">Email</label><input type="email" id="auth-email" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500"></div>
                
                <div class="relative">
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1">Password</label>
                    <input type="password" id="auth-password" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 pr-10">
                    <button type="button" onclick="togglePass('auth-password')" class="absolute right-3 top-8 text-gray-400 hover:text-indigo-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>
                </div>

                <div id="confirm-pass-field" class="hidden relative">
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-400 mb-1">Confirm Password</label>
                    <input type="password" id="auth-pass-confirm" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 pr-10">
                    <button type="button" onclick="togglePass('auth-pass-confirm')" class="absolute right-3 top-8 text-gray-400 hover:text-indigo-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>
                </div>

                <div class="flex justify-between items-center text-sm pt-2">
                    <button type="button" id="toggle-auth-mode" class="font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400">Create an account</button>
                    <button type="button" id="forgot-pass-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">Forgot Password?</button>
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">Sign In</button>
                <p id="auth-error" class="text-center text-white bg-red-500 text-sm hidden font-bold p-3 rounded-lg"></p>
            </form>
        </div>
    </div>

    <div id="app-layout" class="min-h-screen hidden flex flex-col relative">
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40 transition-colors">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="relative">
                    <button id="menu-btn" class="flex items-center space-x-2 text-gray-700 dark:text-gray-200 hover:text-indigo-600 focus:outline-none p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="font-bold text-lg hidden md:inline">Menu</span>
                    </button>
                    <div id="dropdown-content" class="absolute left-0 mt-3 w-72 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 dropdown-menu hidden-menu z-50 overflow-hidden">
                        <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Active Account</p>
                            <p id="menu-current-acc" class="font-bold text-indigo-600 dark:text-indigo-400 truncate text-sm mt-1">No Account Selected</p>
                        </div>
                        <div class="py-2">
                            <button onclick="switchTab('dashboard')" class="w-full text-left px-4 py-3 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center transition"><svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>Dashboard</button>
                            <button onclick="switchTab('accounts')" class="w-full text-left px-4 py-3 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center transition"><svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>My Accounts</button>
                            <button onclick="switchTab('profile')" class="w-full text-left px-4 py-3 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center transition"><svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>Profile</button>
                            <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                            <button id="theme-toggle" class="w-full text-left px-4 py-3 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between transition"><span>Dark / Light Mode</span><svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></button>
                            <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                            <button class="logout-action w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center font-semibold transition">Logout</button>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-gray-800 dark:text-white" id="header-name">User</p>
                </div>
            </div>
        </header>

        <div id="tab-dashboard" class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
            <div id="no-accounts-msg" class="hidden text-center py-20">
                <div class="inline-block p-6 rounded-full bg-gray-100 dark:bg-gray-800 mb-4"><svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div>
                <h3 class="text-xl font-bold text-gray-700 dark:text-white">No Trading Accounts</h3>
                <p class="text-gray-500 mt-2">Go to 'My Accounts' to create your first account.</p>
                <button onclick="switchTab('accounts')" class="mt-6 bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">Get Started</button>
            </div>

            <div id="dashboard-content" class="hidden space-y-6">
                <div id="funded-stats-container" class="hidden bg-gray-900 text-white p-6 rounded-2xl shadow-xl border border-gray-700 relative overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 relative z-10 gap-2">
                        <div><h3 class="font-bold text-2xl tracking-tight" id="dash-acc-name">Account</h3><p class="text-indigo-400 text-sm font-medium uppercase tracking-wider" id="dash-prop-name">Prop Firm</p></div>
                        <span id="dash-phase" class="bg-indigo-600 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest shadow-lg">Phase 1</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 relative z-10">
                        <div><div class="flex justify-between text-xs mb-2 text-gray-400 uppercase font-semibold"><span>Target</span><span id="target-val" class="text-white font-mono">...</span></div><div class="w-full bg-gray-800 rounded-full h-3 shadow-inner"><div id="bar-target" class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div></div>
                        <div><div class="flex justify-between text-xs mb-2 text-gray-400 uppercase font-semibold"><span>Max Drawdown</span><span id="mdd-val" class="text-white font-mono">...</span></div><div class="w-full bg-gray-800 rounded-full h-3 shadow-inner"><div id="bar-mdd" class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div></div>
                        <div><div class="flex justify-between text-xs mb-2 text-gray-400 uppercase font-semibold"><span>Daily Limit</span><span id="ddd-val" class="text-white font-mono">...</span></div><div class="w-full bg-gray-800 rounded-full h-3 shadow-inner"><div id="bar-ddd" class="bg-gradient-to-r from-rose-400 to-rose-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-lg">Performance Curve</h3>
                    <div class="w-full h-72"><canvas id="growthChart"></canvas></div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors"><p class="text-xs font-semibold text-gray-500 uppercase">Balance</p><p id="metric-balance" class="text-2xl font-extrabold mt-1 text-gray-900 dark:text-white tracking-tight">...</p></div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors"><p class="text-xs font-semibold text-gray-500 uppercase">Net PnL</p><p id="metric-pnl" class="text-2xl font-extrabold mt-1">...</p></div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors"><p class="text-xs font-semibold text-gray-500 uppercase">Win Rate</p><p id="metric-winrate" class="text-2xl font-extrabold mt-1 text-gray-900 dark:text-white">...</p></div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 hover:border-indigo-500 transition-colors"><p class="text-xs font-semibold text-gray-500 uppercase">Total Trades</p><p id="metric-trades" class="text-2xl font-extrabold mt-1 text-gray-900 dark:text-white">...</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 h-fit sticky top-24">
                        <h3 class="font-bold mb-5 text-xl text-gray-900 dark:text-white flex items-center"><svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Log New Trade</h3>
                        <form id="trade-form" class="space-y-4">
                            <input type="date" id="t-date" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="t-symbol" placeholder="SYMBOL" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 uppercase font-bold focus:ring-2 focus:ring-indigo-500 shadow-sm">
                                <select id="t-type" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 shadow-sm"><option value="Long">Long ↗</option><option value="Short">Short ↘</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" step="0.00001" id="t-entry" placeholder="Entry Price" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 shadow-sm">
                                <input type="number" step="0.00001" id="t-exit" placeholder="Exit Price" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 shadow-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" step="0.01" id="t-size" placeholder="Size (Lots)" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 shadow-sm">
                                <input type="text" id="t-pnl" placeholder="PnL ($)" readonly class="w-full rounded-lg bg-gray-100 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 text-gray-500 dark:text-gray-300 p-3 font-mono cursor-not-allowed">
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase">Confidence</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="t-conf" min="1" max="5" value="5" class="w-full">
                                    <span id="conf-val" class="text-green-600 dark:text-green-400 font-bold text-lg w-8 text-center">5</span>
                                </div>
                            </div>

                            <textarea id="t-notes" rows="2" placeholder="Thoughts, feelings, strategy..." class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 focus:ring-2 focus:ring-indigo-500 shadow-sm"></textarea>

                            <div class="w-full">
                                <label for="t-img" class="flex flex-col items-center justify-center w-full h-24 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    <div class="flex flex-col items-center justify-center pt-2 pb-3">
                                        <svg class="w-6 h-6 mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" id="file-name-display">Upload Screenshot</p>
                                    </div>
                                    <input id="t-img" type="file" class="hidden" accept="image/*" />
                                </label>
                            </div>

                            <button type="submit" class="w-full bg-indigo-600 text-white py-3.5 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-0.5">Add Trade</button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 dark:text-white">Trade History</h3>
                            <span class="text-xs text-gray-500 bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">Recent</span>
                        </div>
                        <div class="overflow-x-auto max-h-[800px] scroll-shadow flex-grow">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Symbol</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">PnL</th>
                                        <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trade-list" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-accounts" class="hidden flex-grow p-4 md:p-8 max-w-4xl mx-auto w-full">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">My Trading Accounts</h2>
                <button id="new-account-btn" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold hover:bg-indigo-700 shadow-lg transition flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>New Account</button>
            </div>
            <div id="accounts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

        <div id="tab-profile" class="hidden flex-grow p-4 md:p-8 max-w-2xl mx-auto w-full">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">User Profile</h2>
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <form id="profile-form" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">First Name</label><input type="text" id="prof-fname" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2.5"></div><div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Last Name</label><input type="text" id="prof-lname" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2.5"></div></div>
                    <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Email</label><input type="email" id="prof-email" readonly class="w-full rounded-lg bg-gray-100 dark:bg-gray-600 border border-gray-200 dark:border-gray-500 text-gray-500 dark:text-gray-300 p-2.5 cursor-not-allowed"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Date of Birth</label><input type="date" id="prof-dob" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2.5"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Bio</label><textarea id="prof-bio" rows="2" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2.5"></textarea></div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-5">
                        <h4 class="font-bold mb-4 text-gray-800 dark:text-white">Trader DNA</h4>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Experience</label><select id="prof-exp" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-2.5"><option value="">Select...</option><option value="0-1">0-1 Year</option><option value="1-3">1-3 Years</option><option value="3-5">3-5 Years</option><option value="5+">5+ Years</option></select></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Markets (Max 2)</label><div class="flex flex-wrap gap-4 text-sm" id="prof-markets"><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Forex" class="rounded text-indigo-600 focus:ring-indigo-500 market-chk"><span>Forex</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Crypto" class="rounded text-indigo-600 focus:ring-indigo-500 market-chk"><span>Crypto</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Indices" class="rounded text-indigo-600 focus:ring-indigo-500 market-chk"><span>Indices</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Commodities" class="rounded text-indigo-600 focus:ring-indigo-500 market-chk"><span>Commodities</span></label></div></div>
                        <div><label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Strategies (Max 3)</label><div class="relative"><button type="button" id="strat-dropdown-btn" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-left flex justify-between items-center p-2.5" onclick="document.getElementById('strat-list').classList.toggle('hidden')"><span>Select...</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="strat-list" class="hidden absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 mt-1 rounded-lg shadow-xl max-h-48 overflow-y-auto p-3"><div class="grid grid-cols-1 gap-2 text-sm"><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="SMC" class="rounded text-indigo-600 strat-chk"><span>SMC / ICT</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Price Action" class="rounded text-indigo-600 strat-chk"><span>Price Action</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Breakout" class="rounded text-indigo-600 strat-chk"><span>Breakout</span></label><label class="flex items-center space-x-2 text-gray-700 dark:text-gray-200"><input type="checkbox" value="Scalping" class="rounded text-indigo-600 strat-chk"><span>Scalping</span></label></div></div></div></div>
                    </div>
                    <button type="submit" class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-indigo-700 transition w-full md:w-auto shadow-md">Save Changes</button>
                </form>
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 space-y-4">
                    <h3 class="font-bold mb-2 text-gray-900 dark:text-white">Account Security</h3>
                    <button id="prof-reset-pass" class="bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-white text-sm w-full md:w-auto text-left transition">Send Password Reset Email</button>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4"><h3 class="font-bold mb-2 text-red-600">Danger Zone</h3><button onclick="deleteUserProfile()" class="bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 text-sm w-full md:w-auto transition">Delete Entire Profile</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-2xl w-full p-6 shadow-2xl border border-gray-200 dark:border-gray-700 relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 dark:hover:text-white transition bg-gray-100 dark:bg-gray-700 rounded-full p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h3 class="text-2xl font-extrabold mb-6 text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3">Trade Analysis</h3>
            <div id="modal-content" class="space-y-5 text-gray-700 dark:text-gray-300"></div>
        </div>
    </div>

    <div id="wizard-container" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="max-w-2xl w-full bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 border border-gray-200 dark:border-gray-700 relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeWizard()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 dark:hover:text-white transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-2xl font-extrabold mb-6 text-gray-900 dark:text-white">Setup New Account</h2>
            <form id="wizard-form" class="space-y-5">
                <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Account Nickname *</label><input type="text" id="wiz-name" placeholder="e.g. My FTMO 100k" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 required-field"></div>
                <div class="flex space-x-4"><button type="button" id="type-live" class="flex-1 py-3 border-2 border-indigo-600 bg-indigo-600 text-white rounded-xl font-bold transition shadow-md" onclick="setWizType('Live')">Live Account</button><button type="button" id="type-funded" class="flex-1 py-3 border-2 border-gray-200 dark:border-gray-600 text-gray-500 rounded-xl font-bold hover:bg-gray-50 dark:hover:bg-gray-700 transition" onclick="setWizType('Funded')">Funded Challenge</button></div>
                <div><label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Initial Balance *</label><input type="number" id="wiz-balance" placeholder="10000" required class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white p-3 required-field"></div>
                <div id="wiz-funded-opts" class="hidden space-y-4 border-t border-gray-200 dark:border-gray-700 pt-4 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl">
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Prop Firm *</label><input type="text" id="wiz-prop" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white fund-req"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Type</label><select id="wiz-challenge-type" onchange="togglePhaseInputs()" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="2step">2-Step</option><option value="1step">1-Step</option></select></div></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Start At</label><select id="wiz-current-phase" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="1">Phase 1</option><option value="2">Phase 2</option><option value="funded">Funded</option></select></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Phase 1 Target % *</label><input type="number" id="wiz-t1" placeholder="10" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white fund-req"></div><div id="wiz-t2-container"><label class="text-xs font-bold text-gray-500 uppercase">Phase 2 Target % *</label><input type="number" id="wiz-t2" placeholder="5" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white fund-req"></div></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Max DD % *</label><input type="number" id="wiz-mdd" placeholder="10" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white fund-req"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Daily DD % *</label><input type="number" id="wiz-ddd" placeholder="5" class="w-full rounded-lg border p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white fund-req"></div></div>
                </div>
                <p id="wiz-error" class="text-red-500 text-sm hidden font-bold text-center bg-red-50 dark:bg-red-900/20 p-2 rounded">Complete required fields!</p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl mt-4 shadow-lg transition transform hover:-translate-y-0.5">Create Account</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, getDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // ⚙️ CONFIGURATION (YOUR KEYS HERE)
        // ==========================================
        const firebaseConfig = {
        apiKey: "AIzaSyDLqWiGvAMwzjhAZCfrqMVQz2_4F4s7nAc",
        authDomain: "trading-journal-db-eb6e1.firebaseapp.com",
        projectId: "trading-journal-db-eb6e1",
        storageBucket: "trading-journal-db-eb6e1.firebasestorage.app",
        messagingSenderId: "672967817566",
        appId: "1:672967817566:web:10c873bf5726f3424cf7cf",
        measurementId: "G-HXR6WEYN7P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null, currentAccountId = null, currentAccountData = null, tradeUnsubscribe = null, chartInstance = null;

        // UTILS
        window.togglePass = (id) => { const input = document.getElementById(id); input.type = input.type === "password" ? "text" : "password"; };
        const getFriendlyError = (code) => {
            switch(code) { case 'auth/invalid-credential': return "Incorrect email or password."; case 'auth/user-not-found': return "No user found with this email."; default: return code; }
        };
        const getBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
        });

        // SLIDER UI
        const slider = document.getElementById('t-conf'); const output = document.getElementById('conf-val');
        slider.addEventListener('input', function() { output.textContent = this.value; if(this.value < 3) output.className = "text-red-500 font-bold text-lg w-8 text-center"; else if (this.value == 3) output.className = "text-yellow-500 font-bold text-lg w-8 text-center"; else output.className = "text-green-500 font-bold text-lg w-8 text-center"; });

        // FILE UI
        const fileInput = document.getElementById('t-img'); const fileNameDisplay = document.getElementById('file-name-display');
        fileInput.addEventListener('change', function(){ if(this.files && this.files.length > 0) { fileNameDisplay.textContent = this.files[0].name; fileNameDisplay.classList.add('text-indigo-600', 'font-bold'); } else { fileNameDisplay.textContent = "Upload Screenshot"; fileNameDisplay.classList.remove('text-indigo-600', 'font-bold'); } });

        // AUTH
        let isRegistering = false;
        document.getElementById('toggle-auth-mode').addEventListener('click', () => { isRegistering = !isRegistering; document.getElementById('register-fields').classList.toggle('hidden'); document.getElementById('confirm-pass-field').classList.toggle('hidden'); document.getElementById('auth-submit-btn').textContent = isRegistering ? 'Create Account' : 'Sign In'; });
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value; const errorBox = document.getElementById('auth-error'); errorBox.classList.add('hidden');
            try { if(isRegistering) { if(pass !== document.getElementById('auth-pass-confirm').value) throw new Error("Passwords do not match"); const cred = await createUserWithEmailAndPassword(auth, email, pass); await setDoc(doc(db, "users", cred.user.uid), { firstName: document.getElementById('auth-fname').value, lastName: document.getElementById('auth-lname').value, username: document.getElementById('auth-username').value, email: email }); } else { await signInWithEmailAndPassword(auth, email, pass); } } catch (err) { errorBox.textContent = getFriendlyError(err.code||err.message); errorBox.classList.remove('hidden'); }
        });
        document.getElementById('forgot-pass-btn').addEventListener('click', () => document.getElementById('forgot-pass-modal').classList.remove('hidden'));
        document.getElementById('cancel-reset').addEventListener('click', () => document.getElementById('forgot-pass-modal').classList.add('hidden'));
        document.getElementById('send-reset').addEventListener('click', async () => { const email = document.getElementById('reset-email').value; try { await sendPasswordResetEmail(auth, email); alert("Sent"); document.getElementById('forgot-pass-modal').classList.add('hidden'); } catch(e) { alert(e.code); } });

        // OBSERVER
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUserId = user.uid; document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-layout').classList.remove('hidden');
                const uDoc = await getDoc(doc(db, "users", currentUserId));
                if(uDoc.exists()) {
                    const data = uDoc.data(); document.getElementById('header-name').textContent = data.username || "Trader";
                    document.getElementById('prof-fname').value = data.firstName || ""; document.getElementById('prof-lname').value = data.lastName || "";
                    document.getElementById('prof-email').value = data.email || user.email; document.getElementById('prof-dob').value = data.dob || ""; document.getElementById('prof-bio').value = data.bio || "";
                    document.getElementById('prof-exp').value = data.experience || "";
                    (data.markets||[]).forEach(v => { const el = document.querySelector(`.market-chk[value="${v}"]`); if(el) el.checked = true; });
                    (data.strategies||[]).forEach(v => { const el = document.querySelector(`.strat-chk[value="${v}"]`); if(el) el.checked = true; });
                }
                loadAccountsList();
            } else { currentUserId = null; document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-layout').classList.add('hidden'); }
        });

        // PROFILE
        document.querySelectorAll('.market-chk').forEach(chk => { chk.addEventListener('change', () => { if(document.querySelectorAll('.market-chk:checked').length > 2) { chk.checked = false; alert("Max 2 markets allowed."); } }); });
        const updateStratBtn = () => { const count = document.querySelectorAll('.strat-chk:checked').length; document.querySelector('#strat-dropdown-btn span').textContent = count > 0 ? `${count} Selected` : "Select..."; };
        document.querySelectorAll('.strat-chk').forEach(chk => chk.addEventListener('change', updateStratBtn));
        document.getElementById('profile-form').addEventListener('submit', async(e) => {
            e.preventDefault(); const markets = Array.from(document.querySelectorAll('.market-chk:checked')).map(cb=>cb.value); const strategies = Array.from(document.querySelectorAll('.strat-chk:checked')).map(cb=>cb.value);
            await updateDoc(doc(db, "users", currentUserId), { firstName: document.getElementById('prof-fname').value, lastName: document.getElementById('prof-lname').value, dob: document.getElementById('prof-dob').value, bio: document.getElementById('prof-bio').value, experience: document.getElementById('prof-exp').value, markets, strategies }); alert("Profile Saved!");
        });
        document.getElementById('prof-reset-pass').addEventListener('click', async(e) => { e.preventDefault(); if(confirm("Send email?")) { await sendPasswordResetEmail(auth, auth.currentUser.email); alert("Sent."); } });
        window.deleteUserProfile = async () => { if(!confirm("ARE YOU SURE?")) return; const user = auth.currentUser; try { await deleteDoc(doc(db, "users", user.uid)); await deleteUser(user); alert("Deleted."); window.location.reload(); } catch (err) { if(err.code === 'auth/requires-recent-login') alert("Re-login required."); else alert(err.message); } };

        // ACCOUNTS
        const themeToggle = document.getElementById('theme-toggle'); themeToggle.addEventListener('click', (e) => { e.stopPropagation(); document.documentElement.classList.toggle('dark'); });
        document.querySelectorAll('.logout-action').forEach(btn => btn.addEventListener('click', () => signOut(auth)));

        async function loadAccountsList() {
            const q = query(collection(db, `users/${currentUserId}/accounts`), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q); const listContainer = document.getElementById('accounts-list'); listContainer.innerHTML = '';
            if(snap.empty) { document.getElementById('wizard-container').classList.remove('hidden'); document.getElementById('no-accounts-msg').classList.remove('hidden'); document.getElementById('dashboard-content').classList.add('hidden'); return; }
            document.getElementById('no-accounts-msg').classList.add('hidden');
            snap.forEach(doc => { const acc = doc.data(); const div = document.createElement('div'); div.className = "bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 flex justify-between items-center hover:shadow-md transition"; div.innerHTML = `<div><h4 class="font-bold text-lg text-gray-900 dark:text-white">${acc.name}</h4><p class="text-sm text-gray-500">${acc.type} ${acc.type==='Funded'?'• '+acc.propFirm:''}</p><p class="text-xs font-bold mt-1 ${acc.status==='Failed'?'text-red-500':'text-green-500'}">${acc.status||'Active'}</p></div><div class="flex space-x-2"><button onclick="window.selectAccount('${doc.id}')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition">Open</button><button onclick="window.deleteAccount('${doc.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded-lg text-sm transition">Delete</button></div>`; listContainer.appendChild(div); });
            if(!currentAccountId && snap.docs.length > 0) window.selectAccount(snap.docs[0].id);
        }

        window.selectAccount = async (accId) => {
            currentAccountId = accId; const snap = await getDoc(doc(db, `users/${currentUserId}/accounts/${accId}`));
            if(snap.exists()) { currentAccountData = snap.data(); document.getElementById('menu-current-acc').textContent = currentAccountData.name; document.getElementById('dash-acc-name').textContent = currentAccountData.name; document.getElementById('dash-prop-name').textContent = currentAccountData.type === 'Funded' ? currentAccountData.propFirm : 'Live Account'; document.getElementById('dashboard-content').classList.remove('hidden'); switchTab('dashboard'); setupTradeListener(accId); }
        };

        function setupTradeListener(accId) { if(tradeUnsubscribe) tradeUnsubscribe(); const q = query(collection(db, `users/${currentUserId}/accounts/${accId}/trades`), orderBy('date', 'asc')); tradeUnsubscribe = onSnapshot(q, (snap) => { const trades = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderTrades([...trades].reverse()); calcMetrics(trades); }); }

        async function calcMetrics(trades) {
            let balance = currentAccountData.initialBalance, pnl = 0, wins = 0; const chartLabels = ['Start'], chartData = [currentAccountData.initialBalance];
            let dailyPnL = 0; const today = new Date().toISOString().split('T')[0];
            trades.forEach(t => { pnl += t.pnl; balance += t.pnl; if(t.pnl > 0) wins++; if(t.date === today) dailyPnL += t.pnl; chartLabels.push(t.date); chartData.push(balance); });
            if(currentAccountData.type === 'Funded' && (currentAccountData.status !== 'Failed')) {
                const initBal = currentAccountData.initialBalance; const phase = currentAccountData.currentPhase;
                const maxDD = initBal * (currentAccountData.maxDD / 100); const dailyDD = initBal * (currentAccountData.dailyDD / 100);
                if (balance <= (initBal - maxDD) || dailyPnL <= -dailyDD) { await updateDoc(doc(db, `users/${currentUserId}/accounts/${currentAccountId}`), { status: 'Failed' }); currentAccountData.status = 'Failed'; alert("⚠️ Account Limits Breached! Status updated to FAILED."); } 
                else if (phase !== 'funded') { const targetPct = phase === '1' ? currentAccountData.targetP1 : currentAccountData.targetP2; const targetAmt = initBal * (targetPct / 100); if (pnl >= targetAmt) { const nextPhase = phase === '1' && currentAccountData.challengeType === '2step' ? '2' : 'funded'; await updateDoc(doc(db, `users/${currentUserId}/accounts/${currentAccountId}`), { currentPhase: nextPhase }); currentAccountData.currentPhase = nextPhase; alert(`🎉 Target Reached! Promoted to ${nextPhase === 'funded' ? 'FUNDED' : 'Phase 2'}!`); } }
            }
            const ctx = document.getElementById('growthChart').getContext('2d'); const isDark = document.documentElement.classList.contains('dark'); const textColor = isDark ? '#9ca3af' : '#4b5563';
            if(chartInstance) chartInstance.destroy(); chartInstance = new Chart(ctx, { type: 'line', data: { labels: chartLabels, datasets: [{ label: 'Balance', data: chartData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { display:false }, y: { ticks: { color: textColor }, grid: { color: isDark?'#374151':'#e5e7eb' } } }, plugins: { legend: { display: false } } } });
            document.getElementById('metric-balance').textContent = `$${balance.toFixed(2)}`; document.getElementById('metric-pnl').textContent = `$${pnl.toFixed(2)}`; document.getElementById('metric-pnl').className = `text-2xl font-extrabold mt-1 ${pnl >= 0 ? 'text-green-600' : 'text-red-600'}`; document.getElementById('metric-trades').textContent = trades.length; document.getElementById('metric-winrate').textContent = trades.length ? ((wins/trades.length)*100).toFixed(1) + '%' : '0%';
            if(currentAccountData.type === 'Funded') {
                document.getElementById('funded-stats-container').classList.remove('hidden');
                const phaseVal = currentAccountData.currentPhase || "1"; const status = currentAccountData.status || 'Active'; const badge = document.getElementById('dash-phase'); 
                if (status === 'Failed') { badge.textContent = "FAILED"; badge.className = "bg-red-600 text-white px-4 py-1 rounded-full text-xs font-bold"; } else { badge.textContent = phaseVal === 'funded' ? "FUNDED" : `PHASE ${phaseVal}`; badge.className = phaseVal === 'funded' ? "bg-green-600 text-white px-4 py-1 rounded-full text-xs font-bold" : "bg-indigo-600 text-white px-4 py-1 rounded-full text-xs font-bold"; }
                if(phaseVal !== 'funded') { document.getElementById('bar-target').parentElement.parentElement.classList.remove('opacity-50'); const targetPct = phaseVal === '1' ? currentAccountData.targetP1 : currentAccountData.targetP2; const initBal = currentAccountData.initialBalance; const targetAmt = initBal * (targetPct / 100); const pPct = Math.min((pnl / targetAmt) * 100, 100); document.getElementById('target-val').textContent = `$${targetAmt.toFixed(0)} (${targetPct}%)`; document.getElementById('bar-target').style.width = `${Math.max(0, pPct)}%`; } else { document.getElementById('bar-target').parentElement.parentElement.classList.add('opacity-50'); }
                const initBal = currentAccountData.initialBalance; const mddAmt = initBal * (currentAccountData.maxDD / 100); const ddPct = Math.min(((initBal - balance) / mddAmt) * 100, 100); document.getElementById('mdd-val').textContent = `$${mddAmt.toFixed(0)}`; document.getElementById('bar-mdd').style.width = `${Math.max(0, ddPct)}%`; document.getElementById('ddd-val').textContent = `${currentAccountData.dailyDD}%`;
            } else { document.getElementById('funded-stats-container').classList.add('hidden'); }
        }

        function renderTrades(trades) { 
            const tbody = document.getElementById('trade-list'); tbody.innerHTML = ''; 
            trades.forEach(t => { const tr = document.createElement('tr'); const color = t.pnl >= 0 ? 'text-green-600' : 'text-red-600'; tr.innerHTML = `<td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap">${t.date}</td><td class="px-6 py-4 text-sm font-bold text-gray-700 dark:text-gray-200">${t.symbol} <span class="text-xs font-normal text-gray-500">(${t.type})</span></td><td class="px-6 py-4 text-sm text-right font-bold ${color}">${t.pnl.toFixed(2)}</td><td class="px-6 py-4 text-sm text-right space-x-3"><button onclick="window.viewTrade('${t.id}')" class="text-indigo-600 hover:text-indigo-900 dark:hover:text-indigo-400 font-medium">View</button><button onclick="window.deleteTrade('${t.id}')" class="text-red-600 hover:text-red-900 dark:hover:text-red-400 font-medium">Delete</button></td>`; tr.dataset.trade = JSON.stringify(t); tbody.appendChild(tr); }); 
        }

        window.viewTrade = (id) => {
            const rows = document.querySelectorAll('#trade-list tr'); let trade = null; rows.forEach(r => { if(JSON.parse(r.dataset.trade).id === id) trade = JSON.parse(r.dataset.trade); });
            if(trade) {
                const content = document.getElementById('modal-content');
                content.innerHTML = `<div class="grid grid-cols-2 gap-6 text-sm mb-6"><div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"><span class="block text-xs text-gray-500 uppercase font-bold">Symbol</span><span class="text-lg font-bold text-gray-900 dark:text-white">${trade.symbol}</span> <span class="text-xs text-gray-500">(${trade.type})</span></div><div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"><span class="block text-xs text-gray-500 uppercase font-bold">PnL</span><span class="text-lg font-bold ${trade.pnl>=0?'text-green-600':'text-red-600'}">${trade.pnl}</span></div><div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"><span class="block text-xs text-gray-500 uppercase font-bold">Entry</span><span class="font-mono text-gray-900 dark:text-white">${trade.entry}</span></div><div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"><span class="block text-xs text-gray-500 uppercase font-bold">Exit</span><span class="font-mono text-gray-900 dark:text-white">${trade.exit}</span></div></div><div class="mb-6"><span class="block text-xs text-gray-500 uppercase font-bold mb-1">Notes</span><p class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-gray-700 dark:text-gray-300 italic">"${trade.notes || 'No notes'}"</p></div>${trade.image ? `<div><span class="block text-xs text-gray-500 uppercase font-bold mb-2">Screenshot</span><img src="${trade.image}" class="w-full rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm"></div>` : ''}`;
                document.getElementById('details-modal').classList.remove('hidden');
            }
        };

        // WIZARD
        let wizType = 'Live';
        window.setWizType = (type) => { wizType = type; const liveBtn = document.getElementById('type-live'); const fundBtn = document.getElementById('type-funded'); const fundedOpts = document.getElementById('wiz-funded-opts');
            const activeClasses = ['border-indigo-600', 'bg-indigo-600', 'text-white', 'shadow-md']; const inactiveClasses = ['border-gray-200', 'dark:border-gray-600', 'text-gray-500', 'hover:bg-gray-50', 'dark:hover:bg-gray-700'];
            if (type === 'Live') { liveBtn.classList.add(...activeClasses); liveBtn.classList.remove(...inactiveClasses); fundBtn.classList.add(...inactiveClasses); fundBtn.classList.remove(...activeClasses); fundedOpts.classList.add('hidden'); } 
            else { fundBtn.classList.add(...activeClasses); fundBtn.classList.remove(...inactiveClasses); liveBtn.classList.add(...inactiveClasses); liveBtn.classList.remove(...activeClasses); fundedOpts.classList.remove('hidden'); }
        };
        window.togglePhaseInputs = () => { const type = document.getElementById('wiz-challenge-type').value; const t2Container = document.getElementById('wiz-t2-container'); const phaseSelect = document.getElementById('wiz-current-phase'); phaseSelect.innerHTML = '<option value="1">Phase 1</option>'; if (type === '2step') { t2Container.classList.remove('hidden'); phaseSelect.innerHTML += '<option value="2">Phase 2</option>'; } else { t2Container.classList.add('hidden'); } phaseSelect.innerHTML += '<option value="funded">Funded (Live)</option>'; };
        
        document.getElementById('wizard-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let isValid = true; document.querySelectorAll('#wizard-form .required-field').forEach(field => { if (!field.value) { field.classList.add('shake'); isValid = false; } else { field.classList.remove('shake'); } });
            if (wizType === 'Funded') { const type = document.getElementById('wiz-challenge-type').value; document.querySelectorAll('.fund-req').forEach(field => { if (field.id === 'wiz-t2' && type === '1step') return; if (!field.value) { field.classList.add('shake'); isValid = false; } else { field.classList.remove('shake'); } }); }
            if (!isValid) { const err = document.getElementById('wiz-error'); err.classList.remove('hidden'); setTimeout(() => err.classList.add('hidden'), 3000); return; }
            const data = { name: document.getElementById('wiz-name').value, type: wizType, initialBalance: parseFloat(document.getElementById('wiz-balance').value), createdAt: Date.now() };
            if (wizType === 'Funded') { data.propFirm = document.getElementById('wiz-prop').value; data.challengeType = document.getElementById('wiz-challenge-type').value; data.currentPhase = document.getElementById('wiz-current-phase').value; data.targetP1 = parseFloat(document.getElementById('wiz-t1').value) || 10; if (data.challengeType === '2step') { data.targetP2 = parseFloat(document.getElementById('wiz-t2').value) || 5; } data.maxDD = parseFloat(document.getElementById('wiz-mdd').value) || 10; data.dailyDD = parseFloat(document.getElementById('wiz-ddd').value) || 5; }
            try { const docRef = await addDoc(collection(db, `users/${currentUserId}/accounts`), data); document.getElementById('wizard-container').classList.add('hidden'); document.getElementById('wizard-form').reset(); loadAccountsList(); window.selectAccount(docRef.id); } catch (error) { alert("Error: " + error.message); }
        });

        document.getElementById('new-account-btn').addEventListener('click', () => document.getElementById('wizard-container').classList.remove('hidden'));
        window.closeWizard = () => document.getElementById('wizard-container').classList.add('hidden');
        window.switchTab = (tab) => { ['dashboard', 'accounts', 'profile'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden')); document.getElementById(`tab-${tab}`).classList.remove('hidden'); document.getElementById('dropdown-content').classList.add('hidden-menu'); };
        const menuBtn = document.getElementById('menu-btn'); const dropContent = document.getElementById('dropdown-content'); menuBtn.addEventListener('click', (e) => { e.stopPropagation(); if(dropContent.classList.contains('visible-menu')) { dropContent.classList.remove('visible-menu'); dropContent.classList.add('hidden-menu'); } else { dropContent.classList.remove('hidden-menu'); dropContent.classList.add('visible-menu'); } }); document.addEventListener('click', () => { dropContent.classList.remove('visible-menu'); dropContent.classList.add('hidden-menu'); });
        ['t-entry', 't-exit', 't-size', 't-type'].forEach(id => document.getElementById(id).addEventListener('input', () => { const e = parseFloat(document.getElementById('t-entry').value); const x = parseFloat(document.getElementById('t-exit').value); const s = parseFloat(document.getElementById('t-size').value); const t = document.getElementById('t-type').value; if(e && x && s) document.getElementById('t-pnl').value = ((t==='Long'?x-e:e-x)*s).toFixed(2); }));
        
        // TRADE SUBMIT
        document.getElementById('trade-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); const pnl = parseFloat(document.getElementById('t-pnl').value); const imgFile = document.getElementById('t-img').files[0]; let imgBase64 = null;
            if(imgFile) { if(imgFile.size > 500000) return alert("Image too large. Max 500KB."); imgBase64 = await getBase64(imgFile); }
            await addDoc(collection(db, `users/${currentUserId}/accounts/${currentAccountId}/trades`), { date: document.getElementById('t-date').value, symbol: document.getElementById('t-symbol').value.toUpperCase(), type: document.getElementById('t-type').value, entry: parseFloat(document.getElementById('t-entry').value), exit: parseFloat(document.getElementById('t-exit').value), size: parseFloat(document.getElementById('t-size').value), pnl: isNaN(pnl)?0:pnl, confidence: document.getElementById('t-conf').value, notes: document.getElementById('t-notes').value, image: imgBase64, createdAt: Date.now() }); 
            document.getElementById('trade-form').reset(); document.getElementById('conf-val').textContent = "5"; document.getElementById('file-name-display').textContent = "Upload Screenshot"; document.getElementById('file-name-display').classList.remove('text-indigo-600', 'font-bold');
        });

        window.deleteTrade = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, `users/${currentUserId}/accounts/${currentAccountId}/trades/${id}`)); };
        window.deleteAccount = async (id) => { if(confirm("DELETE ACCOUNT?")) { await deleteDoc(doc(db, `users/${currentUserId}/accounts/${id}`)); loadAccountsList(); } };
        
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    </script>
</body>
</html>